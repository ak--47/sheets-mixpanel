<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mixpanel Configuration</title>
	<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
</head>
<!-- TODO: separate assets https://developers.google.com/apps-script/guides/html/best-practices#code.gs -->

<!-- HTML -->

<body>
	<div id="config" class="hidden">
		<?= JSON.stringify(config) ?>
	</div>
	<div id="sheet_info" class="hidden">
		<?= JSON.stringify(sheet) ?>
	</div>
	<section id="auth">
		<div class="prompt">
			<span class="title">ü§ñ Provide your authentication details: </span>
			<span id="service_acct_form">
				<input type="text" id="service_acct" placeholder="service account user" class="data">
				<input type="text" id="service_secret" placeholder="service account secret" class="data">
			</span>
		</div>
	</section>

	<section id="link">
		<div class="prompt">
			<span class="title">üîó Provide the URL of the report you want to sync:</span>
			<input type="text" class="data" id="mixpanel_report_url"
				placeholder="https://mixpanel.com/project/{{pid}}/view/{{wid}}/app/{{report}}/#view/{{bookmark}}/{{title}}">
		</div>
		<span class="note">(note: to sync <b>cohorts</b>, paste a link from your project's cohort list)</span>
	</section>

	<section id="parsing">
		<div class="prompt">
			<span class="title">üõ†Ô∏è Report Params</span>
			<textarea id="display_url_params" cols="50" rows="6" disabled></textarea>
		</div>
	</section>

	<section id="cohort" class="hidden">
		<div class="prompt">
			<span class="title">üë• provide your cohort's id:</span>
			<input type="text" class="data" id="cohort_id" placeholder="2333059">
		</div>
	</section>


	<section id="controls">
		<div>
			<button id="sync" class="action" disabled>
				<svg-icon icon="stop-watch" class="mp-icon">
					<svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22">
						<path d="M6 3a8 8 0 0 0-3 3m16.05.08A8 8 0 0 0 15.93 3" stroke-miterlimit="10"
							stroke-linecap="round" fill="none" stroke="currentColor" stroke-width="1.5"></path>
						<circle cx="11" cy="11" r="6.5" stroke-miterlimit="10" fill="none" stroke="currentColor"
							stroke-width="1.5">
						</circle>
						<path stroke-miterlimit="10" stroke-linecap="round" fill="none" stroke="currentColor"
							stroke-width="1.5" d="M6.05 15.95L4 18m11.95-2.05L18 18"></path>
						<path stroke-linejoin="round" stroke-linecap="round" fill="none" stroke="currentColor"
							stroke-width="1.5" d="M11 8v3h3"></path>
					</svg>
				</svg-icon>
				sync</button>
			<button id="test" class="share" disabled>
				<svg-icon icon="pulse" class="mp-icon">
					<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22">
						<path
							d="M5 10.513a.75.75 0 100 1.5v-1.5zm12 1.5a.75.75 0 000-1.5v1.5zm-2.332-.686l.698.272-.698-.272zm-1.823 4.67l-.703.26.703-.26zm.002 0l.699.273-.699-.272zM9.153 6.004l.708.248-.708-.248zm.002 0l.703-.26-.703.26zM7.33 11.196l.708.248-.708-.248zM5 12.013h2.237v-1.5H5v1.5zm3.039-.569L9.86 6.252l-1.416-.497-1.822 5.194 1.416.496zm.412-5.182l3.69 9.995 1.408-.52-3.69-9.994-1.408.52zm5.095 10.008l1.82-4.67-1.397-.545-1.82 4.67 1.397.545zm1.215-4.257H17v-1.5h-2.24v1.5zm.605-.414a.65.65 0 01-.605.414v-1.5a.85.85 0 00-.792.542l1.397.544zm-3.224 4.658c.24.65 1.153.656 1.404.013l-1.398-.545c.25-.641 1.162-.634 1.4.013l-1.406.52zM9.86 6.251c-.233.662-1.167.67-1.41.011l1.407-.52c-.243-.66-1.18-.652-1.413.012l1.416.497zm-2.624 5.762a.85.85 0 00.802-.569l-1.416-.496a.65.65 0 01.614-.435v1.5z"
							fill="currentColor"></path>
					</svg>
				</svg-icon> test</button>
			<button id="save">
				<svg-icon icon="save" class="mp-icon">
					<svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22">
						<path
							d="M19 8.54v8.86a1.6 1.6 0 0 1-1.6 1.6H4.6A1.6 1.6 0 0 1 3 17.4V4.6A1.6 1.6 0 0 1 4.6 3h8.21a1.6 1.6 0 0 1 1 .39l4.59 3.93a1.6 1.6 0 0 1 .6 1.22z"
							fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
							stroke-width="1.5"></path>
						<circle cx="11" cy="12.6" r="3.2" fill="none" stroke="currentColor" stroke-linecap="round"
							stroke-linejoin="round" stroke-width="1.5"></circle>
						<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
							stroke-width="1.5" d="M10.2 6.2h-4"></path>
						<path fill="currentColor" d="M11 11.6a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"></path>
					</svg>
				</svg-icon>
				save</button>
			<button id="clear" class="create">
				<svg-icon icon="trashcan" class="mp-icon">
					<svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path fill-rule="evenodd" clip-rule="evenodd"
							d="M9.85 3.5a.835.835 0 00-.85.86v.157h3.3V4.36a.834.834 0 00-.85-.861h-1.6V3.5zm3.95 1.017V4.36A2.335 2.335 0 0011.45 2h-1.6A2.335 2.335 0 007.5 4.36v.157H5.25C4.031 4.517 3 5.562 3 6.777v.201c0 .622.21 1.2.63 1.623.27.272.603.457.97.554v7.186c0 1.178.896 2.159 2.05 2.159h8.1c1.155 0 2.05-.981 2.05-2.16V9.172a2.216 2.216 0 001.7-2.194v-.2c0-1.216-1.031-2.26-2.25-2.26H13.8zm1.5 4.721H6.1v7.103c0 .432.305.659.55.659h8.1c.245 0 .55-.227.55-.66V9.238zM4.5 6.778c0-.397.369-.76.75-.76h11c.381 0 .75.363.75.76v.2c0 .464-.336.76-.75.76h-11c-.278 0-.452-.09-.555-.194-.104-.104-.195-.282-.195-.566v-.2zm4.25 3.477a.75.75 0 01.75.75v3.725a.75.75 0 11-1.5 0v-3.725a.75.75 0 01.75-.75zm4.75.75a.75.75 0 00-1.5 0v3.725a.75.75 0 101.5 0v-3.725z"
							fill="currentColor"></path>
					</svg>
				</svg-icon>
				clear</button>
		</div>
		<span class="optional note"><b>syncs</b> run <b>every hour</b>; <b>tests</b> run <b>only once</b></span><br />
		<span id="sheet_footer"></span>
	</section>

	<section id="status" class="bottom">
		<div>
			<div class="mp-spinner hidden" id="loader">
				<svg-icon icon="spinner"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="22"
						height="22">
						<path fill="currentColor"
							d="M43.935 25.145c0-10.318-8.364-18.683-18.683-18.683-10.318 0-18.683 8.365-18.683 18.683h4.068c0-8.071 6.543-14.615 14.615-14.615s14.615 6.543 14.615 14.615h4.068z">
						</path>
					</svg>
				</svg-icon>
			</div>
			<span class="gray"></span>
		</div>
	</section>

	<style>
		/* CSS */

		:root {
			--mixpanel: #7856FF;
			--purple: #4F44E0;
			--red: #E34F2F;
			--orange: #DF7800;
			--green: #219464;
			--lightGray: #626266;
			--gray: #2A2A2F;
			--white: #F6F6F6;
		}

		section {
			padding-bottom: 5px;
		}

		button {
			font-size: 17px;
			text-transform: lowercase !important;
			border-radius: 8px !important;
		}

		select {
			font-size: 14px;
			padding: 2px;
			width: 180px;
			text-indent: 5%;
			text-align: left;
		}

		input[type="text"] {
			width: 180px;
		}

		#display_url_params {
			background-color: var(--white);
			font-family: monospace;
		}

		#mixpanel_report_url {
			width: 550px
		}


		.dropdown {
			width: 140px
		}

		#status {
			position: relative;
		}

		#status span {
			vertical-align: super;
		}

		.title {
			padding-bottom: 5px;
			display: block;
		}


		.mp-icon {
			display: inline-block;
			height: 20px;
			width: 20px;
			vertical-align: text-top;
		}


		div {
			padding: 8px;
		}

		span.note {
			padding-left: 8px;
		}

		#type_label {
			color: var(--red);
			font-weight: bold;
		}

		.field {
			font-family: monospace;
			color: var(--mixpanel);
			font-size: 16px;
		}

		.prompt {
			font-size: 16px;
			color: var(--gray);
		}

		.hidden {
			display: none;
		}

		.optional {
			color: var(--lightGray);
			font-size: 12px;
			opacity: .75;
		}

		li {
			padding-bottom: 4px;
		}

		ul,
		ol {
			list-style: none;
			margin-bottom: 0px;
		}

		/* SPINNER */
		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.mp-spinner {
			height: 20px;
			width: 20px;
			animation: 0.7s linear 0s infinite normal none running spin;
			transform: translateZ(0px);

		}

		.mp-spinner svg-icon {
			display: inline-block;
			height: 100%;
			min-height: 100%;
			min-width: 100%;
			position: relative;
			width: 100%;
		}

		.mp-spinner svg-icon svg {
			color: var(--mixpanel);
		}

		.mp-spinner svg-icon svg {
			display: block;
			height: 100%;
			left: 0px;
			min-height: 100%;
			min-width: 100%;
			position: absolute;
			top: 0px;
			width: 100%;
		}
	</style>
	<script>
		/*
		----
		JAVASCRIPT
		----
		*/
		const qs = document.querySelector.bind(document);
		const qsa = document.querySelectorAll.bind(document);

		const app = {
			DOM: {},
			cohorts: false,
			init,
			cacheDOM,
			bindEvents,
			buildDropdowns,
			getFields,
			checkFields,
			isValid,
			saveConfig,
			parseConfig,
			clearConfig,
			loadConfig,
			getConfig,
			sync,
			parseURL,
			displayURL,
			loader
		};

		function init() {
			this.DOM = this.cacheDOM();
			this.buildDropdowns(this.DOM.sheets);
			this.bindEvents();
			this.loadConfig(this.DOM.config);
		}

		/*
		----
		DOM STUFF
		----
		*/

		function cacheDOM() {
			return {
				mixpanelURL: qs('#mixpanel_report_url'),
				displayURL: qs('#display_url_params'),
				serviceUser: qs('#service_acct'),
				serviceSecret: qs('#service_secret'),
				syncButton: qs('#sync'),
				saveButton: qs('#save'),
				clearButton: qs('#clear'),
				testButton: qs('#test'),
				status: qs('#status span'),
				cohortId: qs('#cohort_id'),
				loader: qs('#loader'),
				cohortContainer: qs('#cohort'),

				// server-side
				sheet: this.parseConfig(qs('#sheet_info')),
				config: this.parseConfig(qs('#config')),
			};
		}

		function buildDropdowns(sheets) {
			// todo
			// const selectMenus = Array.from(qsa('select.data.dropdown'));

			// // columns fail to render; most likely a local test
			// if (JSON.stringify(columns) === '["\\n\\t\\t\\n\\t"]') {
			// 	columns = ['foo', 'bar', 'baz', 'qux', 'mux', 'dux', 'lux', 'trux', 'brux', ' crux'];
			// }

			// for (const select of selectMenus) {
			// 	for (const column of columns) {
			// 		const opt = document.createElement('option');
			// 		opt.value = column;
			// 		opt.innerHTML = column;
			// 		select.appendChild(opt);
			// 	}
			// }

		}

		function bindEvents() {
			// URL parsing
			this.DOM.mixpanelURL.addEventListener('input', () => {
				const urlData = this.parseURL(this.DOM.mixpanelURL.value);
				this.displayURL(urlData);
			});

			// "real-time" field validation
			for (const key in this.DOM) {
				if (this.DOM[key].tagName === 'SELECT') {
					this.DOM[key].addEventListener('change', () => { this.checkFields(); });
				}

				if (this.DOM[key].tagName === 'INPUT') {
					this.DOM[key].addEventListener('input', () => { this.checkFields(); });
				}

			}

			// actions
			this.DOM.saveButton.addEventListener('click', () => { this.saveConfig(); });
			this.DOM.testButton.addEventListener('click', () => { this.testConfig(); });
			this.DOM.syncButton.addEventListener('click', () => { this.sync(); });
			this.DOM.clearButton.addEventListener('click', () => { this.clearConfig(); });

		}

		function displayURL(data) {
			const sadEmoji = ['üò¢', 'üò≠', 'üòø', 'üòû', 'üò©', 'üôÅ', 'üòü', 'üò¶', 'üò®', 'üò∞'];
			const e = sample.bind(sadEmoji);
			this.DOM.displayURL.value = `Project Id: ${data.project_id || e()}\nWorkspace Id: ${data.workspace_id || e()}\nRegion: ${data.region || e()}\nReport Id: ${data.report_id || e()}`;
		}

		/*
		----
		CLIENT SIDE VALIDATION
		----
		*/

		function getConfig() {
			const userData = mergeObj(Object.values(this.getFields()));
			userData.sheet_name = this.DOM.sheet?.sheetName;
			userData.sheet_id = this.DOM.sheet?.id;
			userData.config_type = 'mixpanel-to-sheet';
			return userData;
		}

		function checkFields() {
			const userData = mergeObj(Object.values(this.getFields()));
			userData.config_type = 'mixpanel-to-sheet';
			const valid = this.isValid(userData);
			this.DOM.status.innerText = "";
			this.DOM.saveButton.disabled = false;
			this.DOM.clearButton.disabled = false;
			console.log(JSON.stringify(userData, null, 2));

			if (this.entity_type === 'cohort') {
				this.DOM.cohortContainer.classList.remove('hidden');
			}

			else {
				this.DOM.cohortContainer.classList.add('hidden');
			}



			if (valid) {
				this.DOM.syncButton.disabled = false;
				this.DOM.testButton.disabled = false;
			}

			else {
				this.DOM.syncButton.disabled = true;
				this.DOM.testButton.disabled = true;
			}

		}


		function getFields() {
			// enumerate all visible fields
			const visible = filterObj(this.DOM, (el) => {
				// https://stackoverflow.com/a/21696585
				return el.offsetParent && (el.classList.contains('data'));
			});

			const fields = mapObj(visible, (node) => {
				return { [node.id]: node.value };
			});

			fields.params = this.parseURL(this.DOM.mixpanelURL.value);


			return fields;
		}

		function loader(directive) {
			if (directive === 'show') {
				this.DOM.loader.style.display = 'inline-block';
				this.DOM.loader.classList.remove('hidden');
			}
			if (directive === 'hide') {
				this.DOM.loader.style.display = '';
				this.DOM.loader.classList.add('hidden');
			}
		}

		/*
		----
		LOADING DATA FROM SERVER
		----
		*/


		function parseConfig(node) {
			try {
				return JSON.parse(node.innerText);
			}
			catch (e) {
				return {};
			}
		}

		// todo: refactor this nonsense
		function loadConfig(config, force = false) {
			const {
				service_acct,
				service_secret,
				mixpanel_report_url,

				cohort_id
			} = config;

			if (service_acct || force) setValues('#service_acct', service_acct);
			if (service_secret || force) setValues('#service_secret', service_secret);
			if (mixpanel_report_url || force) setValues('#mixpanel_report_url', mixpanel_report_url);
			if (cohort_id || force) setValues('#cohort_id', cohort_id);

		}

		function setValues(cssSelector, value) {
			Array.from(qsa(cssSelector)).forEach((node) => {
				node.value = value;
				if (node.tagName === 'INPUT') node.dispatchEvent(new Event('input'));
				if (node.tagName === 'SELECT') node.dispatchEvent(new Event('change'));
			});
		}

		/*
		----
		RUN SERVER SIDE FUNCTIONS
		----
		*/

		function saveConfig() {
			try {
				const userData = mergeObj(Object.values(this.getFields()));
				// console.log(JSON.stringify(userData, null, 2));
				google.script.run.withSuccessHandler(() => {
					this.DOM.status.innerText = `configuration saved!`;
					this.DOM.saveButton.disabled = true;
				})
					.setConfig(userData);
			}

			catch (e) {
				this.DOM.status.innerText = `ERROR: ${e.message}`;
			}
		}

		function clearConfig() {
			const defaultConfig = {
				service_acct: "",
				service_secret: "",
				mixpanel_report_url: "",

			};

			try {
				google.script.run.withSuccessHandler(() => {
					this.DOM.status.innerText = `configuration cleared!`;
					this.DOM.clearButton.disabled = true;
					this.loadConfig(defaultConfig, true);
				})
					.clearConfig();
			}

			catch (e) {
				this.DOM.status.innerText = `ERROR: ${e.message}`;
			}


		}


		function sync() {
			// todo
			// try {
			// 	google.script.run.withSuccessHandler(() => {
			// 		this.DOM.status.innerText = `syncing data!`;
			// 		this.DOM.syncButton.disabled = true;
			// 	})
			// 		.syncNow(this.getConfig());
			// }

			// catch (e) {
			// 	this.DOM.status.innerText = `ERROR: ${e.message}`;
			// }
		}

		function testConfig() {
			//todo
		}

		/*
		----
		VALIDATION
		----
		*/

		function isValid(config) {
			const {
				service_acct,
				service_secret,
				mixpanel_report_url,
				project_id,
				workspace_id,
				region,
				report_id,
				cohort_id
			} = config;

			if (!service_acct) return false;
			if (!service_secret) return false;
			if (!mixpanel_report_url) return false;
			if (!project_id) return false;
			if (!workspace_id) return false;
			if (!region) return false;
			if (!report_id && !cohort_id) return false;

			return true;
		}

		// example URLs:
		// direct: https://mixpanel.com/project/2943452/view/3466588/app/retention/#report/38075736/a-retention-report/
		// from board: https://mixpanel.com/project/2943452/view/3466588/app/boards#id=4690699&editor-card-id=%22report-38075736%22

		function parseURL(inputUrl) {
			let project_id, workspace_id, report_id, region;
			try {
				const normalize = decodeURI(inputUrl);
				if (normalize.includes('eu.mixpanel.com')) {
					region = 'EU';
				}
				else {
					region = 'US';
				}
				const [url, hash] = normalize.split(/#(.*)/s);
				const splitURL = url.split('/');
				project_id = splitURL[4];
				workspace_id = splitURL[6];

				// boards URLs are weird
				if (hash.includes(`"report-`)) {
					report_id = hash.split('"').filter(t => t.includes('report-'))[0].replace('report-', '');
				}

				else {
					report_id = hash.split('/')[1];
				}

				//cohorts are treated separately
				if (hash.includes('cohorts')) {
					this.entity_type = 'cohort';
				}

				else {
					this.entity_type = 'report';
				}
			}

			catch (e) {
				project_id = null;
				workspace_id = null;
				region = null,
					report_id = null;
			}



			return {
				project_id,
				workspace_id,
				report_id,
				region
			};
		}


		/*
		----
		UTILITIES
		----
		*/
		function comma(num) {
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		};

		function filterObj(hash, test_function, keysOrValues = "value") {
			let key, i;
			const iterator = Object.keys(hash);
			const filtered = {};

			for (i = 0; i < iterator.length; i++) {
				key = iterator[i];
				if (keysOrValues === 'value') {
					if (test_function(hash[key])) {
						filtered[key] = hash[key];
					}
				}
				if (keysOrValues === 'key') {
					if (test_function(key.toString())) {
						filtered[key] = hash[key];
					}
				}
			}
			return filtered;
		};


		function mapObj(object, mapFn) {
			return Object.keys(object).reduce(function (result, key) {
				result[key] = mapFn(object[key]);
				return result;
			}, {});
		}

		function mergeObj(arr) {
			return arr.reduce(function (acc, current) {
				for (var key in current) {
					if (current.hasOwnProperty(key)) {
						acc[key] = current[key];
					}
				}
				return acc;
			}, {});
		}

		function sample() {
			return this[Math.floor(Math.random() * this.length)];
		}

		app.init(); //üòé BOOM!
	</script>
</body>

</html>